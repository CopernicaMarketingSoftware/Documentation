# Sending bounces with MailerQ

Besides the delivery of regular email messages, MailerQ can also be used for 
sending bounces, or, to be more precise: to send Delivery Status Notifications (DSN).

A Delivery Status Notification is an email message that contains meta
information about the delivery of an email. Mail servers send such DSN
messages to each other when the delivery of an email is delayed, or when the 
delivery has completely failed. And you can even send DSN messages on successful
delivery, although in practice success-notifications are seldomly used.


## Enable DSN messages

In its default configuration, MailerQ does not send DSN messages. Normally, 
results are published in JSON format to the appropriate result queues, where you
can pick them up and process them. Most users find it more convenient to collect
results in JSON format from a message queue than setting up a special incoming 
mail servers to receive and parse incoming bounces.

However, if you do want to receive bounces by mail, you can configure MailerQ
to send out delivery status notifications. This can either be configured 
in the configuration file, so that DSN messages are sent for every failed
delivery, or on a per-message basis.


## Configuration file options




## Configure DSN for individual messages

You can specify for every message individually whether and when MailerQ should
send a delivery status notification. You can do this by adding extra properties
to the JSON (if you inject mails by publishing them to a RabbitMQ message queue 
directly), by using the DSN extension of the ESMTP protocol, by adding meta
headers to the MIME message body, or by using command line options if you
inject mails through the CLI interface.


### Enable notifications through JSON

If you want to receive a bounce message when the delivery fails, you can achieve
this by adding a `dsn` property to the input JSON:

```json
{
    "envelope":     "example@domain.com",
    "recipient":    "friend@example.com",
    "mime":         "MIME-Version: 1.0\r\n....",
    "dsn":          {
        "notify":       "FAILURE",
        "envelope":     "mailer-daemon@example.com",
        "orcpt":        "example@example.com"
        "ret":          "FULL",
        "envid":        "your-specific-identifier"
    }
}
```

The above message contains a simple straightforward email message that
is sent from envelope address example@domain.com to recipient address
friend@example.com, with the full message content being stored in the "mime"
property. Nothing special to see here.

The extra "dsn" property instructs MailerQ (and subsequent mail servers that
will process the mail as well) to send back a DSN message to the envelope 
address when the mail could not be delivered. The "dsn" object can have the 
following five sub properties:

* notify
* envelope
* orcpt
* ret
* envid

The `notify` variable specifies what sort of events should trigger the delivery
status notification. Possible values are "NEVER", "SUCCESS", "FAILURE" and 
"DELAY". If you set it to "FAILURE", MailerQ will only send a bounce back on
failure. It is also allowed to set this to a comma seperated list of 
values. If you set the `notify` property to "SUCCESS,FAILURE", a bounce message
will be sent on successful delivery as well as on failure.

Currently, MailerQ only sends notifications for failures and successful 
deliveries, and not yet for delayed deliveries. However, if you do set the 
`notify` property to "DELAY" and the message does get forwarded to a different
server, this other server may still send delay notifications. In other words: 
even although MailerQ does not yet send delay notifications, that does not mean
that you will never receive such notifications.

The `envelope` property is an optional property that sets the envelope
address to be used for the bounce. You normally set this to an address like 
"mailer-daemon@yourdomain.com". If you do not include this property, the default
value from the configuration file is used.

The property `orcpt` is also an optional property and holds the original 
recipient address. Inside the bounce message generated by MailerQ, this original
recipient address is included in the delivery report. This property is optional;
if you leave it out the actual `recipient` property will be used.

The bounce message that is sent back by MailerQ holds a full delivery
report, as well as the full original message. If you want to save a lot
of network bandwidth, you can set the `ret` property to the value `HDRS`.
By doing so, you instruct MailerQ not to include the full MIME message
in the status notification, but only the original MIME headers.

The last property that you can include in the "dsn" object, is `envid`.
This is a application specific environment ID, and you can set it to
whatever you like. It will be included in the bounce message, so
that you can match the bounces with the sent messages.



## Enable DSN via SMTP

If you inject your mails into MailerQ via SMTP, instead of publishing 
JSON formatted message to the RabbitMQ outbox queue, you can also 
instruct MailerQ to send bounces.

MailerQ supports the DSN extension for the SMTP protocol, and you can
also supply the "notify", "orcpt", "ret" and "envid" variables via
the SMTP protocol:

```smtp

@todo show SMTP communication

```

## Enable DSN via message headers

Using 




## Default settings in the config file




## The special bounce queue





## Sending a Delivery Status Notification by hand

We start with a lame example. In the end, a delivery status notification
is nothing more than a regular MIME formatted email message,  with a 
different content-type. Because you can use MailerQ to send all sorts of
MIME messages, you can also use it for sending DSN messages. You just 
have to pass in an alternative MIME message:

```json
{
    "envelope":     "mailer-daemon@example.com",
    "recipient":    "example@example.com",
    "mime":         "Content-Type: multipart/report\r\n...."
}
```

Above you see the JSON for sending a DSN message. This is not much
different than sending a regular email, with HTML and/or text content.
The notification will be sent from envelope address 
"mailer-daemon@example.com" and to recipient "example@example.com".


## Tell MailerQ to construct DSN messages

You can also instruct MailerQ to create the DSN messages given a regular
email. You can add one extra property to the input JSON, and MailerQ
will send a completely different type of e-mail. Consider the following
input JSON:

```json
{
    "envelope":     "sender@yourdomain.com",
    "recipient":    "receiver@example.com",
    "mime":         "..."
}
```

The above JSON contains the input for sending a regular email to
"receiver@example.com". Imagine however, that you want to send a 
notification back to the original envelope, containing a report about
exactly this original e-mail. You can achieve this by simply adding a 
"report" property to this JSON object. MailerQ will then convert the
mime data into a DSN that is going to be sent back to the 

```json
{
    "envelope":     "sender@yourdomain.com",
    "recipient":    "receiver@example.com",
    "mime":         "....",
    "dsn": {
        "envelope":     "mailer-daemon@example.com",
        "notify":       "FAILURE,DELAY",                /* supported FAILURE, DELAY, SUCCESS and NEVER */
        "orcpt":        "example@example.com",
        "ret":          "FULL",                         /* HDRS of FULL */
        "envid":        "skldfjslfkjsdlk"
    },
    "report":   {
        "original-envelope-id": "....",     envid uit DSN JSON
        "reporting-mta":        "....",     MailerQ (niet configurabel)
        "received-from-mta":    "....",     niet gezet door MailerQ
        "arrival-date":         "....",     niet gezet door MailerQ
        "human-readable":       "....",     niet gezet door MailerQ
        "full":                 boolean,    True als ret=FULL in input JSON
        "recipients": [ {
            "original":             "....",     orcpt in input JSON
            "final":                "....",     gezet op de recipient
            "action":               "....",     "relayed" of "failed" ("delayed" is nog niet geimplementeerd)
            "status":               "....",     "5.2.1" (code geretourneerd door ontvanger)
            "remote-mta":           "....",     niet gezet door MailerQ
            "diagnostic-code":      "....",     de SMTP code
            "last-attempt-date":    "....",     de tijd waarop de laatste poging voor het bericht was ingeroosterd
            "final-log-id":         "....",     niet gebruikt door MailerQ
            "will-retry-until":     "...."      niet gebruikt door MailerQ
        } ]
    }
}
```

When MailerQ detects that the "report" propery was added to the JSON
input, it suddenly








It is
therefore very easy to send DSN messages with MailerQ: just insert the

